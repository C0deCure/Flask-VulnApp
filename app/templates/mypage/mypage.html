<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>마이페이지</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style1.css') }}">

    <style>
        body {
            background-color: #ffffff;
        }
        .card {
            border-radius: 0.75rem;
            border: 1px solid #e9ecef;
            /* ▼▼▼ 레이아웃 간 위아래 마진을 줄였습니다. ▼▼▼ */
            margin-bottom: 1rem; 
            /* ▼▼▼ 레이아웃의 가로 길이를 더 줄였습니다. ▼▼▼ */
            max-width: 500px; 
            margin-left: auto;
            margin-right: auto;
        }
        .card-header {
            background-color: #fff;
            padding: 1rem 1.25rem;
            border-bottom: none !important;
        }
        .list-group-item {
            /* ▼▼▼ [수정] 모든 border 속성을 제거하고 none으로 설정합니다 ▼▼▼ */
            border: none;
            padding: 0.85rem 1.25rem;
            text-align: left;
            font-size: 1.05rem;
        }
        .list-group-item:first-child {
            border-top-left-radius: 0.75rem;
            border-top-right-radius: 0.75rem;
        }
        .list-group-item:last-child {
            border-bottom-left-radius: 0.75rem;
            border-bottom-right-radius: 0.75rem;
        }
        .list-group-item-action {
            color: #212529;
            font-size: 1.05rem;
        }
        .list-group-item-action:hover {
            background-color: #f1f3f5;
        }
        .card-title-secondary {
            font-size: 1.1rem;
            font-weight: 700;
            color: #495057;
            margin-bottom: 0.5rem;
            text-align: left;
        }
        /* ▼▼▼ '내 정보'의 로그아웃 버튼을 위한 새 스타일 ▼▼▼ */
        .custom-logout-btn {
            position: absolute;
            top: 1.25rem;
            right: 1.25rem;
            background-color: #dc3545; /* 빨간색 배경 */
            color: white; /* 흰색 글씨 */
            border-radius: 20px; /* 둥근 모서리 */
            padding: 0.25rem 0.75rem;
            font-size: 0.875rem;
            text-decoration: none;
        }
        .custom-logout-btn:hover {
            background-color: #c82333;
            color: white;
        }
        .custom-input-password {
            background-color: #f8f9fa; /* 살짝 회색 배경 */
            border-radius: 0.5rem; /* 둥근 모서리 */
            border: 1px solid #dee2e6;
        }
    </style>
</head>
<body>
    <nav id="header">
        <div class="wrap">
            <div id="logo">
                <a href="{{ url_for('main.index') }}"><img id="img" src="{{ url_for('static', filename='images/logo.png') }}"></a>
                <p><span class="schoolname">SMULife</span></p>
            </div>
            
            <div id="account" style="display: flex; align-items: center;">
                {% if current_user.is_authenticated %}
                    <a href="{{ url_for('message.room_list') }}" title="쪽지함" 
                    style="margin-right: 10px; border: none; background: none; padding: 0;">
                        <img src="{{ url_for('static', filename='images/message_icon.png') }}" height="28" alt="쪽지함">
                    </a>
                    <a href="{{ url_for('mypage.profile') }}" title="마이페이지" 
                    style="margin-right: 15px; border: none; background: none; padding: 0;">
                        <img src="{{ url_for('static', filename='images/mypage_icon.png') }}" height="28" alt="마이페이지">
                    </a>
                    <span style="margin-right: 10px;">{{ current_user.username }} 님 안녕하세요</span>
                    <a href="{{ url_for('auth.logout') }}" class="button red">로그아웃</a>
                {% endif %}
            </div>
            
            <div id="menu">
                <ul> 
                    <li><a href="#">게시판</a></li> 
                    <li><a href="#">시간표</a></li> 
                    <li><a href="#">강의평가</a></li> 
                    <li><a href="#">학점계산기</a></li> 
                    <li><a href="#">친구</a></li> 
                    <li><a href="#">책방</a></li> 
                    <li><a href="#">캠퍼스픽</a></li> 
                </ul>
            </div>
        </div>
    </nav>

    <div class="container my-5">

        <div class="card mb-2">
            <div class="card-body" style="position: relative; text-align: left;">
                <h5 class="card-title-secondary mb-3">내 정보</h5>
                <div class="d-flex align-items-center">
                    <img id="img" src="{{ url_for('static', filename='images/0.png') }}" style="border-radius: 20px; width: 50px; height: 50px; object-fit: cover;">
                    <div class="ms-3">
                        <h6 class="card-title mb-0 fw-bold">{{ g.user.username if g.user else '사용자' }}</h6>
                        <small class="text-muted">상명대학교 천안캠퍼스</small>
                    </div>
                </div>
                <a href="{{ url_for('auth.logout') }}" class="custom-logout-btn">로그아웃</a>
            </div>
        </div>

        <div class="card mb-2">
            <div class="card-header border-0 pt-3">
                <h6 class="card-title-secondary">계정</h6>
            </div>
            <ul class="list-group list-group-flush">
                <li class="list-group-item d-flex justify-content-between align-items-center">
                    아이디
                    <span class="text-secondary">{{ g.user.username if g.user else 'user_id' }}</span>
                </li>
                <a href="#" class="list-group-item list-group-item-action" data-bs-toggle="modal" data-bs-target="#passwordChangeModal">
                    비밀번호 변경
                </a>
            </ul>
        </div>

        <div class="card mb-2">
            <div class="card-header border-0 pt-3">
                <h6 class="card-title-secondary">커뮤니티</h6>
            </div>
            <ul class="list-group list-group-flush">
                <a href="{{ url_for('mypage.my_posts') }}" class="list-group-item list-group-item-action">게시판 관리</a>
                <a href="{{ url_for('mypage.community_rules') }}" class="list-group-item list-group-item-action">커뮤니티 이용규칙</a>
            </ul>
        </div>

        <div class="card mb-2">
            <div class="card-header border-0 pt-3">
                <h6 class="card-title-secondary">이용 안내</h6>
            </div>
            <ul class="list-group list-group-flush">
                <a href="#" class="list-group-item list-group-item-action">문의하기</a>
                <a href="{{ url_for('mypage.terms_of_service') }}" class="list-group-item list-group-item-action">서비스 이용약관</a>
            </ul>
        </div>

        <div class="card mb-2">
            <div class="card-header border-0 pt-3">
                <h6 class="card-title-secondary">기타</h6>
            </div>
            <ul class="list-group list-group-flush">
                <li class="list-group-item list-group-item-action">
            <form action="{{ url_for('mypage.delete_account') }}" method="post" 
                  onsubmit="return confirm('정말로 탈퇴하시겠습니까? 이 작업은 되돌릴 수 없습니다.');"
                  style="margin: 0; padding: 0;">
                <button type="submit" 
                        style="background: none; 
                               border: none; 
                               padding: 0; 
                               text-align: left; 
                               width: 100%; 
                               color: #212529; 
                               font-size: 1.05rem;">
                    회원 탈퇴
                </button>
            </form>
        </li>
            </ul>
        </div>
    </div>

    <div class="modal fade" id="passwordChangeModal" tabindex="-1" aria-labelledby="passwordChangeModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="passwordChangeModalLabel">비밀번호 변경</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form method="post" id="passwordChangeForm">
                    <div class="modal-body">
                        <input type="hidden" name="id" value="{{ g.user.id if g.user }}">
                        <div class="mb-3">
                            <label for="username" class="form-label">사용자 이름</label>
                            <input type="text" class="form-control" id="username" name="username" value="{{ g.user.username if g.user }}" readonly>
                        </div>
                        <div class="mb-3">
                            <label for="password" class="form-label">새 비밀번호</label>
                            <input type="password" class="form-control custom-input-password" id="password" name="password" placeholder="새 비밀번호" required>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <div class="d-grid w-100">
                            <button type="submit" class="btn btn-danger rounded-pill">비밀번호 변경</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        const passwordForm = document.getElementById('passwordChangeForm');
        passwordForm.addEventListener('submit', function(event) {
            event.preventDefault();
            const formData = new FormData(passwordForm);
            const id = formData.get('id');
            const username = formData.get('username');
            const password = formData.get('password');
            const dataToSend = { id, username, password };
            fetch("{{ url_for('mypage.profile') }}", {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(dataToSend),
            })
            .then(response => response.json())
            .then(data => {
                alert(data.message);
                if (data.status === 'success') {
                    window.location.reload();
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('요청 중 오류가 발생했습니다.');
            });
        });
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
</body>
</html>