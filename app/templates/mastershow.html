{% extends "articleLayout.html" %}

{% block content %}
<div id="main">
    <div id="board">
        <div id="title" class="article">
            <h1>
                <a href="/board/{{ board.url }}">{{ board.name }}</a>
            </h1>
        </div>
        <div id="text" class="article">
            <img class="profileimg" src="{{ url_for('static', filename='images/0.png') }}">
            <div class="profile">
                <h3 class="large">{{ post.user.username }}</h3>
                <time class="large">ìƒì„± ë‚ ì§œ : {{ post.created_at }}</time>
                <time class="large">ìˆ˜ì • ë‚ ì§œ : {{ post.updated_at }}</time>
                {% if current_user.is_authenticated and (current_user.id == post.user_id or current_user.is_admin) %}
                    <a href="/board/{{ board.url }}/delete/{{ post.id }}">
                        <p class="delete">ì‚­ì œ</p>
                    </a>
                    <a href="/board/{{ board.url }}/edit/{{ post.id }}">
                        <p class="edit">ìˆ˜ì •</p>
                    </a>
                {% endif %}
                <h2 class="large">{{ post.title }}</h2>

                <p id="post-text" class="large">{{ post.text | safe }}</p>

                {% if post.file_url %}
                    <div class="uploaded-file" style="margin-top: 20px; padding: 10px; border: 1px dashed #ccc;">
                        <p><strong>ì²¨ë¶€íŒŒì¼:</strong></p>

                        {% if post.file_url.lower().endswith(('.png', '.jpg', '.jpeg', '.gif', '.bmp')) %}
                            <img src="{{ url_for('board.view', filename=post.filename) }}"
                                 alt="{{ post.filename }}"
                                 style="max-width: 100%; height: auto; border: 1px solid #ddd;">

                        {% else %}
                            <a href="{{ url_for('board.view', filename=post.filename) }}"
                               target="_blank"
                               download="{{ post.filename }}">
                                {{ post.filename or 'íŒŒì¼ ë³´ê¸°/ë‹¤ìš´ë¡œë“œ' }}
                            </a>
                        {% endif %}
                    </div>
                {% endif %}
                <div class="vote-widget d-flex align-items-center" data-post-id="{{ post.id }}">
                    <button class="btn btn-outline-secondary btn-sm vote-btn upvote" data-value="1" title="ì¶”ì²œ">
                        <i class="fa-regular fa-thumbs-up"></i>
                    </button>

                    <span class="total-votes mx-2 fw-bold">{{ post.total_votes }}</span>

                    <button class="btn btn-outline-secondary btn-sm vote-btn downvote" data-value="-1" title="ë¹„ì¶”ì²œ">
                        <i class="fa-regular fa-thumbs-down"></i>
                    </button>
                </div>

            </div>
        </div>
        <div id="comment" data-post-id="{{ post.id }}" data-current-user-id="{{ current_user.id if current_user.is_authenticated else '' }}">
            <form id="replyForm" action="/board/{{ board.url }}/{{ post.id }}/comment" method="post" class="writecomment">
                <input type="text" id="commentInput" name="text" placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”" class="commentblank">
                <input type="hidden" name="parent_id" value="{{ parent_comment.id if parent_comment else '' }}">
                <input type="submit" id="submit-btn" class="submit">
            </form>
        </div>
    </div>
</div>
<div class="modal fade" id="editModal" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">

      <div class="modal-header">
        <h5 class="modal-title" id="editModalLabel">ëŒ“ê¸€ ìˆ˜ì • ğŸ“</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <div class="modal-body">
        <form id="edit-form">
          <input type="hidden" id="edit-comment-id">

          <div class="mb-3">
            <label for="edit-new-content" class="form-label">ìˆ˜ì •í•  ë‚´ìš©</label>
            <textarea class="form-control" id="edit-new-content" rows="5" required></textarea>
          </div>

          <p id="modal-result-message" class="text-danger text-center"></p>
        </form>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ì·¨ì†Œ</button>
        <button type="submit" form="edit-form" class="btn btn-primary">ìˆ˜ì • ì™„ë£Œ</button>
      </div>

    </div>
  </div>
</div>

{% endblock %}
{% block script %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.2.3/purify.min.js"></script>
<script type='text/javascript'>
    const textContent = "{{ post.text | safe }}";
    document.getElementById("post-text").innerHTML = DOMPurify.sanitize(textContent);
</script>
<script type='text/javascript'>
    // ===== Bootstrap ëª¨ë‹¬ ì¸ìŠ¤í„´ìŠ¤ ìƒì„± =====
    const editModalElement = document.getElementById('editModal');
    const editModal = new bootstrap.Modal(editModalElement);

    const editForm = document.getElementById('edit-form');
    const hiddenCommentIdInput = document.getElementById('edit-comment-id');
    const newContentInput = document.getElementById('edit-new-content');
    const modalResultMessage = document.getElementById('modal-result-message');

</script>
<script src="{{ url_for('static', filename='js/comments.js') }}"></script>
{% endblock %}