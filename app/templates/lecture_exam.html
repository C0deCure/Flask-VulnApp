{% extends "base_lecture.html" %}

{% block title %}시험 정보{% endblock %}

{% block head %}
    <style>
        /* 필요하다면 여기에만 적용될 스타일을 추가하세요. */
    </style>
{% endblock %}

{% block content %}
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
        <h3 style="margin:0;">시험 정보</h3>
        <div>
            <a href="{{ url_for('lecture.exam_info_write', lecture_id=lec.lecture_id) }}" class="btn" style="margin-right:6px;">등록하기</a>
            <a href="{{ url_for('lecture.lecture_reviews', lecture_id=lec.lecture_id) }}" class="btn">강의평으로</a>
        </div>
    </div>

    {% if exams and exams|length %}
        <ul style="list-style:none;padding:0;margin:0;display:flex;flex-direction:column;gap:12px;">
        {% for ex in exams %}
            <li class="card">
                <div style="font-weight:700;font-size:18px;margin-bottom:8px;">{{ ex.title }}</div>

                {% if ex.unlocked %}
                    <div class="grid">
                        <div class="label">시험 전략</div>
                        <div style="white-space:pre-wrap">{{ ex.strategy or '-' }}</div>

                        <div class="label">문제 유형</div>
                        <div>{{ ex.types or '-' }}</div>

                        <div class="label">문제 예시</div>
                        <div>
                            {% if ex.samples and ex.samples|length %}
                                <ul style="list-style:disc;padding-left:18px;margin:0;">
                                {% for s in ex.samples %}
                                    <li style="margin:2px 0">{{ s }}</li>
                                {% endfor %}
                                </ul>
                            {% else %}-{% endif %}
                        </div>
                    </div>
                
                {% else %}
                    <p style="margin:4px 0 10px 0;">
                        이 정보를 열람하기 위해 <span class="danger">5 포인트</span>가 차감됩니다.
                        한 번 열람한 후에는 영구적으로 볼 수 있습니다.
                    </p>
                    <form action="{{ url_for('lecture.exam_info_view', exam_id=ex.exam_id) }}" method="post" class="view-form">
                        <input type="hidden" name="point" value="0">
                        <button type="button" class="btn red view-btn">열람하기</button>
                    </form>
                    
                    <div class="blur" style="white-space:pre-wrap;line-height:1.6;">
                        {% if ex.strategy %}[시험 전략]
{{ ex.strategy }}


{% endif %}
                        {% if ex.types %}[문제 유형]
{{ ex.types }}


{% endif %}
                        {% if ex.samples and ex.samples|length %}[문제 예시]
{{ ex.samples[0] }}{% if ex.samples|length>1 %}
...{% endif %}{% endif %}
                    </div>
                {% endif %}
            </li>
        {% endfor %}
        </ul>
    {% else %}
        <p style="color:#777;font-size:12px;">등록된 시험 정보가 없습니다.</p>
    {% endif %}
{% endblock %}

{% block scripts %}
<script>
    // 서버에서 넘어온 포인트 값 (기본값 0)
    const MY_POINT = {{ my_point or 0 }};
    const PRICE = 5;

    document.addEventListener('DOMContentLoaded', function() {
        document.querySelectorAll('.view-form').forEach((form) => {
            const btn = form.querySelector('.view-btn');
            if (!btn) return;

            btn.addEventListener('click', async function () {
                const confirmed = window.confirm("포인트 5점을 차감하시겠습니까?");
                if (!confirmed) return;

                if (MY_POINT < PRICE) {
                    alert("포인트가 부족합니다. 먼저 강의평이나 시험 정보를 공유해주세요");
                }

                const params = new URLSearchParams();
                params.set('my_point', MY_POINT); 

                try {
                    await fetch(form.action, {
                        method: 'POST',
                        credentials: 'same-origin',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8',
                            'X-Requested-With': 'XMLHttpRequest'
                        },
                        body: params.toString()
                    });
                } catch (err) {
                    console.error("요청 중 오류:", err);
                }

                window.location.reload();
            });
        });
    });
</script>
{% endblock %}